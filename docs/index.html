<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nyxstone: Nyxstone</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Nyxstone
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Nyxstone </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a></p>
<p><a href="https://github.com/emproof-com/nyxstone/actions/workflows/cpp.yml"><img src="https://github.com/emproof-com/nyxstone/actions/workflows/cpp.yml/badge.svg" alt="Github Cpp CI Badge" style="pointer-events: none;" class="inline"/></a> <a href="https://crates.io/crates/nyxstone"><img src="https://img.shields.io/crates/v/nyxstone.svg" alt="crates.io" style="pointer-events: none;" class="inline"/></a> <a href="https://pypi.org/project/nyxstone"><img src="https://img.shields.io/pypi/v/nyxstone.svg" alt="PyPI" style="pointer-events: none;" class="inline"/></a></p>
<p>Nyxstone is a powerful assembly and disassembly library based on LLVM. It doesnâ€™t require patches to the LLVM source tree and links against standard LLVM libraries available in most Linux distributions. Implemented as a C++ library, Nyxstone also offers Rust and Python bindings. It supports all official LLVM architectures and allows to configure architecture-specific target settings.</p>
<p><img src="/images/demo.svg" alt="Nyxstone Python binding demo" style="pointer-events: none;" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Index</h1>
<ol type="1">
<li>Core Features</li>
<li>Using Nyxstone<ol type="a">
<li>Prerequisites</li>
<li>CLI Tool</li>
<li>C++ Library</li>
<li>Rust Bindings</li>
<li>Python Bindings</li>
</ol>
</li>
<li>How it works</li>
<li>Roadmap</li>
<li>License</li>
<li>Contributing</li>
<li>Contributors</li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
Core Features</h1>
<ul>
<li>Assembles and disassembles code for all architectures supported by LLVM 15, including x86, ARM, MIPS, RISC-V and others.</li>
<li>C++ library based on LLVM with Rust and Python bindings.</li>
<li>Native platform support for Linux and macOS.</li>
<li>Supports labels in the assembler, including the specification of label-to-address mappings</li>
<li>Assembles and disassembles to raw bytes and text, but also provides detailed instruction objects containing the address, raw bytes, and the assembly representation.</li>
<li>Disassembly can be limited to a user-specified number of instructions from byte sequences.</li>
<li>Allows to configure architecture-specific target features, such as ISA extensions and hardware features.</li>
</ul>
<p>For a comprehensive list of supported architectures, you can use <code>clang -print-targets</code>. For a comprehensive list of features for each architecture, refer to <code>llc -march=ARCH -mattr=help</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Disclaimer: Nyxstone has been primarily developed and tested for x86_64, AArch64, and ARM32 architectures. We have a high degree of confidence in its ability to accurately generate assembly and identify errors for these platforms. For other architectures, Nyxstone's effectiveness depends on the reliability and performance of their respective LLVM backends.</dd></dl>
<h1><a class="anchor" id="autotoc_md3"></a>
Using Nyxstone</h1>
<p>This section provides instructions on how to get started with Nyxstone, covering the necessary prerequisites, how to use the CLI tool, and step-by-step guidelines for using the library with C++, Rust, and Python.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Prerequisites</h2>
<p>Before building Nyxstone, ensure clang and LLVM 15 are present as statically linked libraries. Nyxstone looks for <code>llvm-config</code> in your system's <code>$PATH</code> or the specified environment variable <code>$NYXSTONE_LLVM_PREFIX/bin</code>.</p>
<p>Installation Options for LLVM 15:</p>
<ul>
<li>Debian/Ubuntu <div class="fragment"><div class="line">sudo apt install llvm-15 llvm-15-dev</div>
<div class="line">export NYXSTONE_LLVM_PREFIX=/usr/lib/llvm-15/</div>
</div><!-- fragment --></li>
<li>Homebrew (macOS, Linux and others): <div class="fragment"><div class="line">brew install llvm@15</div>
<div class="line">export NYXSTONE_LLVM_PREFIX=/opt/homebrew/opt/llvm@15</div>
</div><!-- fragment --></li>
<li>From LLVM Source:</li>
</ul>
<p><em>Note</em>: On Windows you need to run these commands from a Visual Studio 2022 x64 command prompt. Additionally replace <code>~lib/my-llvm-15</code> with a different path.</p>
<div class="fragment"><div class="line"># checkout llvm</div>
<div class="line">git clone -b release/15.x --single-branch https://github.com/llvm/llvm-project.git</div>
<div class="line">cd llvm-project</div>
<div class="line"> </div>
<div class="line"># build LLVM with custom installation directory</div>
<div class="line">cmake -S llvm -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DLLVM_PARALLEL_LINK_JOBS=1</div>
<div class="line">cmake --build build</div>
<div class="line">cmake --install build --prefix ~/lib/my-llvm-15</div>
<div class="line"> </div>
<div class="line"># export path</div>
<div class="line">export NYXSTONE_LLVM_PREFIX=~/lib/my-llvm-15</div>
</div><!-- fragment --><p>Also make sure to install any system dependent libraries needed by your LLVM version for static linking. They can be viewed with the command <code>llvm-config --system-libs</code>; the list can be empty. On Ubuntu/Debian, you will need the packages <code>zlib1g-dev</code> and <code>zlibstd-dev</code>.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
CLI Tool</h2>
<p>Nyxstone comes with a handy <a href="examples/nyxstone-cli.cpp">CLI tool</a> for quick assembly and disassembly tasks. Checkout the Nyxstone repository, and build the tool with CMake:</p>
<div class="fragment"><div class="line"># clone directory</div>
<div class="line">git clone https://github.com/emproof-com/nyxstone</div>
<div class="line">cd nyxstone</div>
<div class="line"> </div>
<div class="line"># build nyxstone</div>
<div class="line">mkdir build &amp;&amp; cd build &amp;&amp; cmake .. &amp;&amp; make </div>
</div><!-- fragment --><p>Then, <code>nyxstone</code> can be used from the command line. Here's an output of its help menu:</p>
<div class="fragment"><div class="line">$ ./nyxstone -h</div>
<div class="line">Usage: nyxstone [-t=&lt;triple&gt;] [-p=&lt;pc&gt;] [-d] &lt;input&gt;</div>
<div class="line"> </div>
<div class="line">Examples:</div>
<div class="line">  # Assemble an instruction with the default architecture (&#39;x86_64&#39;).</div>
<div class="line">  nyxstone &#39;push eax&#39;</div>
<div class="line"> </div>
<div class="line">  # Disassemble the bytes &#39;ffc300d1&#39; as AArch64 code.</div>
<div class="line">  nyxstone -t aarch64 -d ffc300d1</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  -t, --triple=&lt;triple&gt;      LLVM target triple or alias, e.g. &#39;aarch64&#39;</div>
<div class="line">  -c, --cpu=&lt;cpu&gt;            LLVM CPU specifier, e.g. &#39;cortex-a53&#39;</div>
<div class="line">  -f, --features=&lt;list&gt;      LLVM architecture/CPU feature list, e.g. &#39;+mte,-neon&#39;</div>
<div class="line">  -p, --address=&lt;pc&gt;         Initial address to assemble/disassemble relative to</div>
<div class="line">  -l, --labels=&lt;list&gt;        Label-to-address mappings (used when assembling only)</div>
<div class="line">  -d, --disassemble          Treat &lt;input&gt; as bytes to disassemble instead of assembly</div>
<div class="line">  -h, --help                 Show this help and usage message</div>
<div class="line"> </div>
<div class="line">Notes:</div>
<div class="line">  The &#39;--triple&#39; parameter also supports aliases for common target triples:</div>
<div class="line"> </div>
<div class="line">     &#39;x86_32&#39; -&gt; &#39;i686-linux-gnu&#39;</div>
<div class="line">     &#39;x86_64&#39; -&gt; &#39;x86_64-linux-gnu&#39;</div>
<div class="line">     &#39;armv6m&#39; -&gt; &#39;armv6m-none-eabi&#39;</div>
<div class="line">     &#39;armv7m&#39; -&gt; &#39;armv7m-none-eabi&#39;</div>
<div class="line">     &#39;armv8m&#39; -&gt; &#39;armv8m.main-none-eabi&#39;</div>
<div class="line">    &#39;aarch64&#39; -&gt; &#39;aarch64-linux-gnueabihf&#39;</div>
<div class="line"> </div>
<div class="line">  The CPUs for a target can be found with &#39;llc -mtriple=&lt;triple&gt; -mcpu=help&#39;.</div>
<div class="line">  The features for a target can be found with &#39;llc -mtriple=&lt;triple&gt; -mattr=help&#39;.</div>
</div><!-- fragment --><p>Now, we can assemble an instruction for the x86_64 architecture:</p>
<div class="fragment"><div class="line">$ ./nyxstone -t x86_64 &quot;mov rax, rbx&quot;</div>
<div class="line">        0x00000000: mov rax, rbx                     ; 48 89 d8</div>
</div><!-- fragment --><p>We can also assemble a sequence of instructions. In the following, we make use of label-based addressing and assume the first instruction is mapped to address <code>0xdeadbeef</code>:</p>
<div class="fragment"><div class="line">$ ./nyxstone -t x86_64 -p 0xdeadbeef &quot;cmp rax, rbx; jz .exit; inc rax; .exit: ret&quot;</div>
<div class="line">        0xdeadbeef: cmp rax, rbx                     ; 48 39 d8 </div>
<div class="line">        0xdeadbef2: je .exit                         ; 74 03 </div>
<div class="line">        0xdeadbef4: inc rax                          ; 48 ff c0 </div>
<div class="line">        0xdeadbef7: ret                              ; c3 </div>
</div><!-- fragment --><p>Furthermore, we can disassemble instructions for different instruction sets, here the ARM32 thumb instruction set:</p>
<div class="fragment"><div class="line">$ ./nyxstone -t thumbv8 -d &quot;13 37&quot;</div>
<div class="line">        0x00000000: adds r7, #19                     ; 13 37 </div>
</div><!-- fragment --><p>Using the support for user-defined labels, we can assemble this snippet which does not contain the label <code>.label</code> by specifying its memory location ourself.</p>
<div class="fragment"><div class="line">$ ./nyxstone -p &quot;0x1000&quot; -l &quot;.label=0x1238&quot; &quot;jmp .label&quot;</div>
<div class="line">        0x00001000: jmp .label                       ; e9 33 02 00 00</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
C++ Library</h2>
<p>To use Nyxstone as a C++ library, your C++ code has to be linked against Nyxstone and LLVM 15.</p>
<p>The following cmake example assumes Nyxstone in a subdirectory <code>nyxstone</code> in your project:</p>
<div class="fragment"><div class="line">add_subdirectory(nyxstone)</div>
<div class="line"> </div>
<div class="line">add_executable(my_executable main.cpp)</div>
<div class="line">target_link_libraries(my_executable nyxstone::nyxstone)</div>
</div><!-- fragment --><p>The corresponding C++ usage example:</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;nyxstone.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span>, <span class="keywordtype">char</span>**) {</div>
<div class="line">    <span class="comment">// Create the nyxstone instance:</span></div>
<div class="line">    <span class="keyword">auto</span> nyxstone {</div>
<div class="line">        NyxstoneBuilder(<span class="stringliteral">&quot;x86_64&quot;</span>)</div>
<div class="line">            .build()</div>
<div class="line">            .value()</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// Assemble to bytes</span></div>
<div class="line">    std::vector&lt;uint8_t&gt; bytes = </div>
<div class="line">        nyxstone-&gt;assemble(<span class="comment">/*assembly=*/</span><span class="stringliteral">&quot;mov rax, rbx&quot;</span>, <span class="comment">/*address=*/</span>0x1000, <span class="comment">/* labels= */</span> {}).value();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;uint8_t&gt; expected {0x48, 0x89, 0xd8};</div>
<div class="line">    assert(bytes == expected);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>For a comprehensive C++ example, take a look at <a href="examples/example.cpp">example.cpp</a>.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Rust Bindings</h2>
<p>To use Nyxstone as a Rust library, add it to your <code>Cargo.toml</code>and use it as shown in the following example:</p>
<div class="fragment"><div class="line">use anyhow::Result;</div>
<div class="line">use nyxstone::{Nyxstone, NyxstoneConfig};</div>
<div class="line"> </div>
<div class="line">use std::collections::HashMap;</div>
<div class="line"> </div>
<div class="line">fn main() -&gt; Result&lt;()&gt; {</div>
<div class="line">    let nyxstone = Nyxstone::new(&quot;x86_64&quot;, NyxstoneConfig::default())?;</div>
<div class="line"> </div>
<div class="line">    let bytes = nyxstone.assemble_with(</div>
<div class="line">        &quot;mov rax, rbx; cmp rax, rdx; jne .label&quot;,</div>
<div class="line">        0x1000,</div>
<div class="line">        &amp;HashMap::from([(&quot;.label&quot;, 0x1200)]),</div>
<div class="line">    )?;</div>
<div class="line"> </div>
<div class="line">    println!(&quot;Bytes: {:x?}&quot;, bytes);</div>
<div class="line"> </div>
<div class="line">    Ok(())</div>
<div class="line">}</div>
</div><!-- fragment --><p>For more instructions regarding the Rust binding, take a look at the corresponding README.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Python Bindings</h2>
<p>To use Nyxstone from Python, install it using pip:</p>
<div class="fragment"><div class="line">pip install nyxstone</div>
</div><!-- fragment --><p>Then, you can use it from Python:</p>
<div class="fragment"><div class="line">$ python -q</div>
<div class="line">&gt;&gt;&gt; from nyxstone import Nyxstone</div>
<div class="line">&gt;&gt;&gt; nyxstone = Nyxstone(&quot;x86_64&quot;)</div>
<div class="line">&gt;&gt;&gt; nyxstone.assemble(&quot;jne .loop&quot;, 0x1100, {&quot;.loop&quot;: 0x1000})</div>
</div><!-- fragment --><p>Detailed instructions are available in the corresponding README.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
How it works</h1>
<p>Nyxstone leverages public C++ API functions from LLVM such as <code>Target::createMCAsmParser</code> and <code>Target::createMCDisassembler</code> to perform assembly and disassembly tasks. Nyxstone also extends two LLVM classes, <code>MCELFStreamer</code> and <code>MCObjectWriter</code>, to inject custom logic and extract additional information. Specifically, Nyxstone augments the assembly process with the following steps:</p>
<ul>
<li><code>ELFStreamerWrapper::emitInstruction</code>: Captures assembly representation and initial raw bytes of instructions if detailed instruction objects are requested by the user.</li>
<li><code>ObjectWriterWrapper::writeObject</code>: Writes the final raw bytes of instructions (with relocation adjustments) to detailed instruction objects. Furthermore, it switches raw bytes output from complete ELF file to just the .text section.</li>
<li><code>ObjectWriterWrapper::validate_fixups</code>: Conducts extra checks, such as verifying the range and alignment of relocations.</li>
<li><code>ObjectWriterWrapper::recordRelocation</code>: Applies additional relocations. <code>MCObjectWriter</code> skips some relocations that are only applied during linking. Right now, this is only relevant for the <code>fixup_aarch64_pcrel_adrp_imm21</code> relocation of the Aarch64 instruction <code>adrp</code>.</li>
</ul>
<p>While extending LLVM classes introduces some drawbacks, like a strong dependency on a specific LLVM version, we believe this approach is still preferable over alternatives that require hard to maintain patches in the LLVM source tree.</p>
<p>We are committed to further reduce the project's complexity and open to suggestions for improvement. Looking ahead, we may eliminate the need to extend LLVM classes by leveraging the existing LLVM infrastructure in a smarter way or incorporating additional logic in a post-processing step.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Roadmap</h1>
<p>Below are some ideas and improvements we believe would significantly advance Nyxstone. The items are not listed in any particular order:</p>
<ul>
<li>[ ] Check thread safety</li>
<li>[ ] Add support for more LLVM versions (auto select depending on found LLVM library version)</li>
<li>[ ] Explore option to make LLVM apply all relocations (including <code>adrp</code>) by configuring <code>MCObjectWriter</code> differently or using a different writer</li>
<li>[ ] Explore option to generate detailed instructions objects by disassembling the raw bytes output of the assembly process instead of relying on the extension of LLVM classes</li>
<li>[ ] Explore option to implement extra range and alignment of relocations in a post-processing step instead of relying on the extension of LLVM classes</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
License</h1>
<p>Nyxstone is available under the [MIT license](LICENSE).</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Contributing</h1>
<p>We welcome contributions from the community! If you encounter any issues with Nyxstone, please feel free to open a GitHub issue.</p>
<p>If you are interested in contributing directly to the project, you can for example:</p>
<ul>
<li>Address an existing issue</li>
<li>Develop new features</li>
<li>Improve documentation</li>
</ul>
<p>Once you're ready, submit a pull request with your changes. We are looking forward to your contribution!</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Contributors</h1>
<p>The current contributors are:</p>
<p><b>Core</b>:</p><ul>
<li>Philipp Koppe (emproof)</li>
<li>Rachid Mzannar (emproof)</li>
<li>Darius Hartlief (emproof)</li>
</ul>
<p><b>Minor</b>:</p><ul>
<li>Marc Fyrbiak (emproof)</li>
<li>Tim Blazytko (emproof) </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
